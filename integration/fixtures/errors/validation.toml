[[test]]
name = 'DuplicateCol'
query = '''
--! new_author(id?, id?)
INSERT INTO Author (id, name) VALUES (:id, :id);
'''
migration = '''
CREATE TABLE author (
  id SERIAL,
  name TEXT
);
'''
error = '''
err: cornucopia::validation::duplicate_nullable_col

  × Couldn't validate queries.
   ╭─[queries/module_1.sql:1:1]
 1 │ --! new_author(id?, id?)
   ·                ─┬   ─┬
   ·                 │    ╰── this nullable column name is already in use
   ·                 ╰── first used here
 2 │ INSERT INTO Author (id, name) VALUES (:id, :id);
   ╰────'''

[[test]]
name = 'ColumnAlreadyNullable'
query = '''
--! new_author: (id?, name?, id?)
SELECT id, name FROM Author;
'''
migration = '''
CREATE TABLE author (
  id SERIAL,
  name TEXT
);
'''
error = '''
err: cornucopia::validation::duplicate_nullable_col

  × Couldn't validate queries.
   ╭─[queries/module_1.sql:1:1]
 1 │ --! new_author: (id?, name?, id?)
   ·                  ─┬          ─┬
   ·                   │           ╰── this nullable column name is already in use
   ·                   ╰── first used here
 2 │ SELECT id, name FROM Author;
   ╰────'''

[[test]]
name = 'InvalidNullableColumnName'
query = '''
--! new_author: (name?)
SELECT id FROM Author;
'''
migration = '''
CREATE TABLE author (
  id SERIAL,
  name TEXT
);
'''
error = '''
err: cornucopia::validation::invalid_nullable_col

  × Couldn't validate queries.
   ╭─[queries/module_1.sql:1:1]
 1 │ --! new_author: (name?)
   ·                  ──┬─
   ·                    ╰── no column with this name found
 2 │ SELECT id FROM Author;
   ╰────'''

[[test]]
name = 'QueryAlreadyExists'
query = '''
--! new_author
SELECT id FROM Author;

--! new_author
SELECT id FROM Author;
'''
migration = '''
CREATE TABLE author (
  id SERIAL,
  name TEXT
);
'''
error = '''
err: cornucopia::validation::duplicate_query_name

  × Couldn't validate queries.
   ╭─[queries/module_1.sql:1:1]
 1 │ --! new_author
   ·     ─────┬────
   ·          ╰── first defined here
 2 │ SELECT id FROM Author;
 3 │ 
 4 │ --! new_author
   ·     ─────┬────
   ·          ╰── this query name is already in use
 5 │ SELECT id FROM Author;
   ╰────'''

[[test]]
name = 'NamedStructInvalidFields'
query = '''
--! author_names: Row
SELECT name FROM Author;

--! author_ids: Row
SELECT id FROM Author;
'''
migration = '''
CREATE TABLE author (
  id SERIAL,
  name TEXT
);
'''
error = '''
err: cornucopia::validation::incompatible_named_structs

  × Couldn't validate queries.
   ╭─[queries/module_1.sql:1:1]
 1 │ --! author_names: Row
   ·                   ─┬─
   ·                    ╰── column `name` defined here
 2 │ SELECT name FROM Author;
 3 │ 
 4 │ --! author_ids: Row
   ·                 ─┬─
   ·                  ╰── column `name` not found
 5 │ SELECT id FROM Author;
   ╰────'''
